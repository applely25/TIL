# λΉ„λ°€λ²νΈ μ•”νΈν™”

μƒνƒ: In progress

**Crypto module(**μ•”νΈν™” λ¨λ“) :  OpenSSLμ ν•΄μ‹, HMAC, μ•”νΈ, ν•΄λ…, μ„λ… λ° ν™•μΈ κΈ°λ¥μ„ ν¬ν•¨ν•λ” μ•”ν™”ν™” κΈ°λ¥μ„ μ κ³µν•¨

### ν•΄μ‹(hash)

- ν•΄μ‹ : ν•΄μ‹ ν•¨μμ— μν•΄ μ–»μ–΄μ§€λ” κ°’
- ν•΄μ‹ ν•¨μ : μ„μμ κΈΈμ΄μ λ°μ΄ν„°λ¥Ό κ³ μ •λ κΈΈμ΄μ λ°μ΄ν„°λ΅ λ§¤ν•‘ν•λ” ν•¨μ
    
    (λ§¤ν•‘ : ν•λ‚μ κ°’μ„ λ‹¤λ¥Έ κ°’μΌλ΅ λ€μ‘μ‹ν‚¤λ” κ²ƒ)
    
    - ν‚¤ : λ§¤ν•‘ μ „ μ›λ λ°μ΄ν„° κ°’
    - ν•΄μ‹ κ°’ : λ§¤ν•‘ ν›„ λ°μ΄ν„° κ°’
    - ν•΄μ‹± : λ§¤ν•‘ν•λ” κ³Όμ •
    

### λ‹¨λ°©ν–¥ μ•”νΈν™”μ™€ μ–‘λ°©ν–¥ μ•”νΈν™”

λ‹¨λ°©ν–¥ : μ•”νΈν™”λ¥Ό ν•  μ μμ§€λ§ λ³µνΈν™” μ•λ¨ β†’ Hash λ°©μ‹

μ–‘λ°©ν–¥ : μ•”νΈν™”, λ³µνΈν™” λ¨λ‘ κ°€λ¥ β†’ λ€μΉ­ν‚¤, λΉ„λ€μΉ­ν‚¤

 **β†’ λ‹¨λ°©ν–¥ μ•”ν™”ν™” λ°©μ‹ μ‚¬μ©**

### ν•΄μ‹ μ•κ³ λ¦¬μ¦

λ‹¤μ–‘ν• ν•΄μ‹ μ•κ³ λ¦¬μ¦μ΄ μ΅΄μ¬

β‡’ ν•΄μ‹ μ•κ³ λ¦¬μ¦μ€ ν•΄μ»¤λ“¤μ—κ²λ„ κ³µκ°  β†’ μ΄λ―Έ λ³΄μ•μ΄ λ«μΈ ν•¨μ μ΅΄μ¬

β†’ `MD5, SHA-1`, `HAS-180` μ‚¬μ© κΈμ§€

β‡’ μ•μ „ν• `SHA-256`, `SHA-512` μ‚¬μ©

### λΉ„λ°€λ²νΈ μ•”νΈν™” ν•κΈ°

`crypto`μ `createHach()` λ©”μ†λ“ μ‚¬μ©

- createHash() : μ‚¬μ©ν•  μ•κ³ λ¦¬μ¦
- update() : μ•”νΈν™”ν•  λΉ„λ°€λ²νΈ
- digest() : μ„μ½”λ”© λ°©μ‹
    
    ```jsx
    import crypto form "crypto";
    
    const createHashedPassword = (password) => {
        return crypto.createHash("sha512").update(password).digest("base64");
    };
    
    console.log(createHashedPassword("1234"));
    console.log(createHashedPassword("1234"));
    console.log(createHashedPassword("1234"));
    
    /*
      1ARVn2Auq2/WAqx2gNrL+q3RNjAzXpUfCXrzkA6d4Xa22yhRLy4AC50E+6UTPoscbo31nbOoq51gvkuXzJ6B2w==
      1ARVn2Auq2/WAqx2gNrL+q3RNjAzXpUfCXrzkA6d4Xa22yhRLy4AC50E+6UTPoscbo31nbOoq51gvkuXzJ6B2w==
    	1ARVn2Auq2/WAqx2gNrL+q3RNjAzXpUfCXrzkA6d4Xa22yhRLy4AC50E+6UTPoscbo31nbOoq51gvkuXzJ6B2w==
    */
    ```
    

**λ¬Έμ μ **

**λ μΈλ³΄μ° ν…μ΄λΈ”** : λΉ„λ°€λ²νΈκ°€ λ™μΌν• κ²½μ° β†’ κ°™μ€ ν•΄μ‹ κ°’μ„ λ°ν™

β‡’ ν•΄μ»¤κ°€ μ„μμ κ°’μ„ μ…λ ¥ν•μ—¬ μ μ¶” κ°€λ¥

---

λ³΄μ• λ°©λ²•

1. μ…λ ¥κ°’μ— `salt`λΌλ” νΉμ • κ°’μ„ λ¶™μ—¬ λ³€ν•μ‹ν‚΄
2. ν•΄μ‹ ν•¨μλ¥Ό μ—¬λ¬λ² λλ¦¬κΈ°

### λΉ„λ°€λ²νΈ μ•”νΈν™” λ³΄μ•ν•κΈ°

`salt` μƒμ„± ( 1λ² or 2λ² )

1.  `crypto` λ¨λ“μ `randomBytes()`, λΉ„λ°€λ²νΈ μ•”νΈν™” 
2. κ²€μ¦μ—μ„ `pbkdf2()` λ©”μ†λ“ μ‚¬μ©

**salt μƒμ„±**

64λ°”μ΄νΈ κΈΈμ΄λ΅ μƒμ„±

`buffer` ν•μ‹μ„ κ°€μ§€κ³  μμ β†’ `base64` λ¬Έμμ—΄λ΅ λ³€κ²½ν•μ—¬ λλ¤ λ¬Έμμ—΄ λ¨                                          

<aside>
π’΅ `salt` β†’ κ²€μ¦μ„ μ„ν•΄ νμ›κ°€μ…μ‹ passwordμ™€ ν•¨κ»DBμ— μ €μ¥ ν•„μ”

</aside>

**λΉ„λ°€λ²νΈ μ•”νΈν™”**

`pbkd2()` λ©”μ†λ“ μ‚¬μ©

- ν•΄μ‹±ν•  κ°’
- salt
- ν•΄μ‹ ν•¨μ λ°λ³µ νμ (λ”± λ–¨μ–΄μ§€λ” μλ³΄λ‹¤ μ΄μƒν• μκ°€ λ‚«μ)
- ν•΄μ‹ κ°’ κΈΈμ΄
- ν•΄μ‹ μ•κ³ λ¦¬μ¦
    
    ```jsx
    const createSalt = async () => {
      const buf = await randomBytesPromise(64);
    
      return buf.toString("base64");
    };
    
    export const createHashedPassword = async (password) => {
      const salt = await createSalt();
      const key = await pbkdf2Promise(password, salt, 104906, 64, "sha512");
    //password -> ν•΄μ‹ν•  κ°’  //salt  //104906 -> ν•΄μ‹ λ°λ³µ νμ
    //64 -> ν•΄μ‹ κ°’ κΈΈμ΄  //sha512 -> ν•΄μ‹ μ•κ³ λ¦¬μ¦
      const hashedPassword = key.toString("base64");
    
      return { hashedPassword, salt };
    };
    ```
    

**λΉ„λ°€λ²νΈ κ²€μ¦**

- password : λ΅κ·ΈμΈ μΈμ¦ν•  λ•μ μ‚¬μ©μκ°€ μ…λ ¥ν• λΉ„λ°€λ²νΈ
- userSalt : DBμ— μ €μ¥λμ–΄μλ” μ‚¬μ©μμ `salt`
- userPassword : DBμ— μ €μ¥λμ–΄μλ” μ‚¬μ©μμ μ•”νΈν™”λ λΉ„λ°€λ²νΈ(ν•΄μ‹ κ°’)

β†’ λ³µνΈν™”λ” λ¶κ°€λ¥ν•κΈ° λ•λ¬Έμ— μ•”νΈν™”λ¥Ό μ§„ν–‰ν•΄μ„ λΉ„κµ

β†’ μΌμΉν•λ©΄true, μΌμΉν•μ§€ μ•μΌλ©΄ false λ°ν™

```jsx
export const verifyPassword = async (password, userSalt, userPassword) => {
  const key = await pbkdf2Promise(password, userSalt, 99999, 64, "sha512");
  const hashedPassword = key.toString("base64");

  if (hashedPassword === userPassword) return true;
  return false;
};

passport.use(
  new LocalStrategy(
    {
      session: true, // μ„Έμ… μ €μ¥ μ—¬λ¶€
      usernameField: "id", // form > input name
      passwordField: "password",
    },
    async (id, password, done) => {
      try {
        // νμ›μ •λ³΄ μ΅°ν
        const user = await User.findOne({
          where: {
            email: id,
          },
          raw: true,
        });

        // νμ›μ •λ³΄κ°€ μ—†λ” κ²½μ°
        if (!user) {
          done(null, false, {
            message: "μ΅΄μ¬ν•μ§€ μ•λ” μ•„μ΄λ””μ…λ‹λ‹¤.",
          });
        }

        const verified = await verifyPassword(
          password,
          user.salt,
          user.password
        );
        // λΉ„λ°€λ²νΈκ°€ μΌμΉν•μ§€ μ•λ” κ²½μ°
        if (!verified) {
          done(null, false, {
            message: "λΉ„λ°€λ²νΈκ°€ μΌμΉν•μ§€ μ•μµλ‹λ‹¤.",
          });
        }
        done(null, user); // serializeUserλ΅ user μ „λ‹¬
      } catch {
        done(null, false, {
          message: "μ„λ²„μ λ¬Έμ κ°€ λ°μƒν–μµλ‹λ‹¤. μ μ‹ ν›„ λ‹¤μ‹ μ‹λ„ν•΄ μ£Όμ„Έμ”.",
        });
      }
    }
  )
);
```